<div class="container">
  <div class="row gap-3">
    <div class="col-lg-4 text-center">
      <h2 class="mt-3">Send a new message</h2>
      <form action="/insert_message" method="post">
        <div class="form-group">
          <label for="recipient_id_box">Recipient</label>
          <select id="recipient_id_box" name="query_recipient_id" class="form-select">
            <% User.all.order(:last_name).each do |a_user| %>
            <% next if a_user.id == @current_user.id %>
            <option value="<%= a_user.id %>">
              <%= a_user.first_name %> <%= a_user.last_name %>
            </option>
            <% end %>
          </select>
        </div>
        <div class="form-group">
          <label for="body_box" class="form-label mt-4">Message</label>
          <textarea class="form-control" id="body_box" name="query_body" rows="5"></textarea>
        </div>
        <button class="btn btn-primary mt-3">Send message</button>
      </form>
    </div>
    <div class="col-lg-7">
      <div class="container text-center">
        <div class="btn-group mt-5" role="group" aria-label="Conversation links">
          <% @threads.each do |thread_key, messages| %>
          <a href="#myDiv<%= thread_key[0] %>_<%= thread_key[1] %>" class="btn btn-primary">
            <%= User.find(thread_key[1]).first_name %>
          </a>
          <% end %>
        </div>
      </div>
      <div class="container">
        <% @threads.each do |thread_key, messages| %>
        <div class="thread my-5">
          <div class="card rounded-3 bg-light">
            <h2 class="card-header fs-5"><em>Conversation with <span style="color: #133851;"><%= User.find(thread_key[1]).first_name %></span></em></h2>
            <div id="myDiv<%= thread_key[0] %>_<%= thread_key[1] %>" style="height: 400px; overflow-y: scroll;" class="card-body">
              <% messages.each do |message| %>
              <div class="message <%= message.sender_id == @current_user.id ? 'sent' : 'received' %> rounded-3">
                <p class="pt-3 px-3"><%= message.body %></p>
                <p class="text-end me-3 pb-2 fst-italic fst-lighter">Sent: <%= message.created_at.strftime("%-d %b %Y, at %-l:%M %p") %></p>
              </div>
              <% end %>
            </div>
          </div>
        </div>
        <% end %>
      </div>
    </div>
  </div>
</div>




<style>
.message.sent {
  background-color: lightgreen;
}

.message.received {
  background-color: lightgrey;
}

.thread {
  margin-bottom: 20px;


</style>


<script>
  document.addEventListener("DOMContentLoaded", function() {
    console.log("JavaScript code executed")
    <% @threads.each do |thread_key, messages| %>
      var myDiv<%= thread_key[0] %>_<%= thread_key[1] %> = document.getElementById("myDiv<%= thread_key[0] %>_<%= thread_key[1] %>");
      myDiv<%= thread_key[0] %>_<%= thread_key[1] %>.scrollTop = myDiv<%= thread_key[0] %>_<%= thread_key[1] %>.scrollHeight;
    <% end %>
  });
</script>
